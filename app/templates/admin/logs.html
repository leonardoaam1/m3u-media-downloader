{% extends "base/layout.html" %}

{% block title %}Logs do Sistema - MediaDown{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('main.dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('admin.admin_dashboard') }}">Administração</a></li>
                            <li class="breadcrumb-item active">Logs</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-1">
                        <i class="bi bi-file-text me-2"></i>
                        Logs do Sistema
                    </h1>
                    <p class="text-muted mb-0">Monitoramento e análise de logs detalhados</p>
                </div>
                <div>
                    <button class="btn btn-outline-danger" onclick="cleanupOldLogs()">
                        <i class="bi bi-trash me-1"></i>
                        Limpar Logs Antigos
                    </button>
                    <button class="btn btn-outline-primary" onclick="exportLogs()">
                        <i class="bi bi-download me-1"></i>
                        Exportar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card bg-primary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-file-text display-6 opacity-75"></i>
                    <h3 class="mt-2 mb-0" id="total-logs">-</h3>
                    <small>Total de Logs</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <i class="bi bi-info-circle display-6 opacity-75"></i>
                    <h3 class="mt-2 mb-0" id="info-logs">-</h3>
                    <small>Info</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card bg-warning text-white">
                <div class="card-body text-center">
                    <i class="bi bi-exclamation-triangle display-6 opacity-75"></i>
                    <h3 class="mt-2 mb-0" id="warning-logs">-</h3>
                    <small>Warnings</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card bg-danger text-white">
                <div class="card-body text-center">
                    <i class="bi bi-x-circle display-6 opacity-75"></i>
                    <h3 class="mt-2 mb-0" id="error-logs">-</h3>
                    <small>Errors</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card bg-secondary text-white">
                <div class="card-body text-center">
                    <i class="bi bi-bug display-6 opacity-75"></i>
                    <h3 class="mt-2 mb-0" id="debug-logs">-</h3>
                    <small>Debug</small>
                </div>
            </div>
        </div>
        
        <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
            <div class="card bg-dark text-white">
                <div class="card-body text-center">
                    <i class="bi bi-exclamation-diamond display-6 opacity-75"></i>
                    <h3 class="mt-2 mb-0" id="critical-logs">-</h3>
                    <small>Critical</small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Log Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-funnel me-2"></i>
                        Filtros e Pesquisa
                    </h5>
                </div>
                <div class="card-body">
                    <form class="row g-3" id="log-filters">
                        <div class="col-md-3">
                            <label for="log-type" class="form-label">Tipo de Log</label>
                            <select class="form-select" id="log-type" name="log_type">
                                <option value="">Todos os tipos</option>
                                <option value="system">Sistema</option>
                                <option value="user_activity">Atividade de Usuário</option>
                                <option value="download">Downloads</option>
                                <option value="transfer">Transferências</option>
                                <option value="tmdb">TMDB</option>
                                <option value="server">Servidores</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="log-level" class="form-label">Nível</label>
                            <select class="form-select" id="log-level" name="level">
                                <option value="">Todos</option>
                                <option value="debug">Debug</option>
                                <option value="info">Info</option>
                                <option value="warning">Warning</option>
                                <option value="error">Error</option>
                                <option value="critical">Critical</option>
                            </select>
                        </div>
                        
                        <div class="col-md-2">
                            <label for="date-from" class="form-label">Data Inicial</label>
                            <input type="date" class="form-control" id="date-from" name="date_from">
                        </div>
                        
                        <div class="col-md-2">
                            <label for="date-to" class="form-label">Data Final</label>
                            <input type="date" class="form-control" id="date-to" name="date_to">
                        </div>
                        
                        <div class="col-md-3">
                            <label for="search-query" class="form-label">Pesquisar</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="search-query" name="search" 
                                       placeholder="Pesquisar em mensagens...">
                                <button class="btn btn-outline-secondary" type="button" onclick="clearFilters()">
                                    <i class="bi bi-x"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <div class="d-flex align-items-center gap-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search me-1"></i>
                                    Filtrar
                                </button>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
                                    <label class="form-check-label" for="auto-refresh">
                                        Auto-atualizar (30s)
                                    </label>
                                </div>
                                
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="show-details">
                                    <label class="form-check-label" for="show-details">
                                        Mostrar detalhes
                                    </label>
                                </div>
                                
                                <select class="form-select" style="width: auto;" id="page-size" onchange="changePageSize()">
                                    <option value="50">50 por página</option>
                                    <option value="100" selected>100 por página</option>
                                    <option value="200">200 por página</option>
                                    <option value="500">500 por página</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Real-time Log Stream -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-activity me-2"></i>
                        Stream de Logs em Tempo Real
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-success" onclick="toggleLogStream()" id="stream-btn">
                            <i class="bi bi-play me-1"></i>
                            Iniciar Stream
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearLogStream()">
                            <i class="bi bi-trash me-1"></i>
                            Limpar
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="log-stream-container" id="log-stream" style="height: 300px; overflow-y: auto; background: #1e1e1e; color: #fff; font-family: 'Courier New', monospace; font-size: 12px;">
                        <div class="p-3 text-muted">
                            <i class="bi bi-info-circle me-2"></i>
                            Clique em "Iniciar Stream" para ver logs em tempo real
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Log Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-table me-2"></i>
                        Histórico de Logs
                    </h5>
                    <div>
                        <span class="text-muted me-3" id="logs-count">Carregando...</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                            <i class="bi bi-arrow-clockwise me-1"></i>
                            Atualizar
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="logs-table-container">
                        <div class="text-center py-5">
                            <div class="loading-spinner"></div>
                            <p class="text-muted mt-2">Carregando logs...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="card-footer">
                    <nav aria-label="Logs pagination">
                        <ul class="pagination justify-content-center mb-0" id="logs-pagination">
                            <!-- Pagination will be populated by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalhes do Log</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="log-details-content">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .log-entry {
        padding: 0.5rem 1rem;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        font-size: 11px;
        line-height: 1.4;
    }
    
    .log-entry:hover {
        background: rgba(255,255,255,0.05);
    }
    
    .log-timestamp {
        color: #888;
    }
    
    .log-level {
        font-weight: bold;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 10px;
    }
    
    .log-level.debug { background: #6c757d; color: white; }
    .log-level.info { background: #0dcaf0; color: white; }
    .log-level.warning { background: #ffc107; color: black; }
    .log-level.error { background: #dc3545; color: white; }
    .log-level.critical { background: #6f42c1; color: white; }
    
    .log-message {
        color: #f8f9fa;
        word-break: break-word;
    }
    
    .log-source {
        color: #adb5bd;
        font-style: italic;
    }
    
    .table-logs tr {
        cursor: pointer;
    }
    
    .table-logs tr:hover {
        background-color: rgba(0,123,255,0.1);
    }
    
    .level-badge {
        font-size: 0.7rem;
        padding: 0.25rem 0.5rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    let currentPage = 1;
    let currentFilters = {};
    let logStreamActive = false;
    let logStreamInterval = null;
    let autoRefreshInterval = null;
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        loadLogStatistics();
        loadLogs();
        setupAutoRefresh();
        
        // Setup form submission
        document.getElementById('log-filters').addEventListener('submit', function(e) {
            e.preventDefault();
            applyFilters();
        });
        
        // Set default dates (last 7 days)
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        
        document.getElementById('date-to').value = today.toISOString().split('T')[0];
        document.getElementById('date-from').value = lastWeek.toISOString().split('T')[0];
    });
    
    function loadLogStatistics() {
        fetch('/api/admin/log_statistics')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('total-logs').textContent = data.stats.total || 0;
                    document.getElementById('info-logs').textContent = data.stats.info || 0;
                    document.getElementById('warning-logs').textContent = data.stats.warning || 0;
                    document.getElementById('error-logs').textContent = data.stats.error || 0;
                    document.getElementById('debug-logs').textContent = data.stats.debug || 0;
                    document.getElementById('critical-logs').textContent = data.stats.critical || 0;
                }
            })
            .catch(error => console.error('Error loading log statistics:', error));
    }
    
    function loadLogs() {
        const params = new URLSearchParams({
            page: currentPage,
            per_page: document.getElementById('page-size').value,
            ...currentFilters
        });
        
        fetch(`/api/admin/logs?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayLogs(data.logs);
                    updatePagination(data.pagination);
                    document.getElementById('logs-count').textContent = `${data.pagination.total} logs encontrados`;
                } else {
                    document.getElementById('logs-table-container').innerHTML = 
                        '<div class="alert alert-danger m-3">Erro ao carregar logs</div>';
                }
            })
            .catch(error => {
                console.error('Error loading logs:', error);
                document.getElementById('logs-table-container').innerHTML = 
                    '<div class="alert alert-danger m-3">Erro ao carregar logs</div>';
            });
    }
    
    function displayLogs(logs) {
        const container = document.getElementById('logs-table-container');
        const showDetails = document.getElementById('show-details').checked;
        
        if (logs.length === 0) {
            container.innerHTML = '<div class="text-center py-5"><p class="text-muted">Nenhum log encontrado</p></div>';
            return;
        }
        
        let html = `
            <div class="table-responsive">
                <table class="table table-hover table-logs mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="140">Timestamp</th>
                            <th width="80">Nível</th>
                            <th width="100">Tipo</th>
                            <th>Mensagem</th>
                            ${showDetails ? '<th width="100">Fonte</th>' : ''}
                            <th width="60">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        logs.forEach(log => {
            const timestamp = new Date(log.timestamp).toLocaleString();
            const levelClass = getLevelClass(log.level);
            const typeIcon = getTypeIcon(log.type);
            
            html += `
                <tr onclick="showLogDetails('${log.id}')">
                    <td><small>${timestamp}</small></td>
                    <td><span class="badge level-badge bg-${levelClass}">${log.level.toUpperCase()}</span></td>
                    <td><i class="bi ${typeIcon} me-1"></i>${log.type}</td>
                    <td class="text-truncate" style="max-width: 400px;" title="${escapeHtml(log.message)}">${escapeHtml(log.message)}</td>
                    ${showDetails ? `<td><small>${log.source || 'N/A'}</small></td>` : ''}
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); showLogDetails('${log.id}')" title="Ver Detalhes">
                            <i class="bi bi-eye"></i>
                        </button>
                    </td>
                </tr>
            `;
        });
        
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }
    
    function getLevelClass(level) {
        const classes = {
            'debug': 'secondary',
            'info': 'info',
            'warning': 'warning',
            'error': 'danger',
            'critical': 'dark'
        };
        return classes[level] || 'secondary';
    }
    
    function getTypeIcon(type) {
        const icons = {
            'system': 'bi-gear',
            'user_activity': 'bi-person',
            'download': 'bi-download',
            'transfer': 'bi-arrow-repeat',
            'tmdb': 'bi-film',
            'server': 'bi-server'
        };
        return icons[type] || 'bi-file-text';
    }
    
    function applyFilters() {
        const form = document.getElementById('log-filters');
        const formData = new FormData(form);
        
        currentFilters = {};
        for (let [key, value] of formData.entries()) {
            if (value) {
                currentFilters[key] = value;
            }
        }
        
        currentPage = 1;
        loadLogs();
    }
    
    function clearFilters() {
        document.getElementById('log-filters').reset();
        currentFilters = {};
        currentPage = 1;
        loadLogs();
    }
    
    function refreshLogs() {
        loadLogs();
        loadLogStatistics();
    }
    
    function changePageSize() {
        currentPage = 1;
        loadLogs();
    }
    
    function updatePagination(pagination) {
        const container = document.getElementById('logs-pagination');
        let html = '';
        
        // Previous button
        if (pagination.has_prev) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${pagination.prev_num})">Anterior</a></li>`;
        }
        
        // Page numbers
        const start = Math.max(1, pagination.page - 2);
        const end = Math.min(pagination.pages, pagination.page + 2);
        
        for (let i = start; i <= end; i++) {
            const isActive = i === pagination.page ? 'active' : '';
            html += `<li class="page-item ${isActive}"><a class="page-link" href="#" onclick="goToPage(${i})">${i}</a></li>`;
        }
        
        // Next button
        if (pagination.has_next) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${pagination.next_num})">Próximo</a></li>`;
        }
        
        container.innerHTML = html;
    }
    
    function goToPage(page) {
        currentPage = page;
        loadLogs();
    }
    
    function showLogDetails(logId) {
        const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
        const modalContent = document.getElementById('log-details-content');
        
        modalContent.innerHTML = '<div class="text-center"><div class="loading-spinner"></div></div>';
        modal.show();
        
        fetch(`/api/admin/logs/${logId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayLogDetails(data.log);
                } else {
                    modalContent.innerHTML = '<div class="alert alert-danger">Erro ao carregar detalhes do log</div>';
                }
            })
            .catch(error => {
                console.error('Error loading log details:', error);
                modalContent.innerHTML = '<div class="alert alert-danger">Erro ao carregar detalhes do log</div>';
            });
    }
    
    function displayLogDetails(log) {
        const modalContent = document.getElementById('log-details-content');
        const timestamp = new Date(log.timestamp).toLocaleString();
        
        const html = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Timestamp:</strong><br>
                    ${timestamp}
                </div>
                <div class="col-md-3">
                    <strong>Nível:</strong><br>
                    <span class="badge bg-${getLevelClass(log.level)}">${log.level.toUpperCase()}</span>
                </div>
                <div class="col-md-3">
                    <strong>Tipo:</strong><br>
                    ${log.type}
                </div>
            </div>
            
            <hr>
            
            <div class="mb-3">
                <strong>Mensagem:</strong><br>
                <div class="bg-light p-3 rounded">${escapeHtml(log.message)}</div>
            </div>
            
            ${log.source ? `
                <div class="mb-3">
                    <strong>Fonte:</strong><br>
                    ${log.source}
                </div>
            ` : ''}
            
            ${log.details ? `
                <div class="mb-3">
                    <strong>Detalhes:</strong><br>
                    <pre class="bg-dark text-white p-3 rounded"><code>${JSON.stringify(log.details, null, 2)}</code></pre>
                </div>
            ` : ''}
            
            ${log.user_id ? `
                <div class="mb-3">
                    <strong>Usuário:</strong><br>
                    ${log.username || log.user_id}
                </div>
            ` : ''}
            
            ${log.ip_address ? `
                <div class="mb-3">
                    <strong>IP:</strong><br>
                    ${log.ip_address}
                </div>
            ` : ''}
        `;
        
        modalContent.innerHTML = html;
    }
    
    function toggleLogStream() {
        const btn = document.getElementById('stream-btn');
        
        if (logStreamActive) {
            stopLogStream();
            btn.innerHTML = '<i class="bi bi-play me-1"></i>Iniciar Stream';
            btn.className = 'btn btn-sm btn-outline-success';
        } else {
            startLogStream();
            btn.innerHTML = '<i class="bi bi-stop me-1"></i>Parar Stream';
            btn.className = 'btn btn-sm btn-outline-danger';
        }
        
        logStreamActive = !logStreamActive;
    }
    
    function startLogStream() {
        const container = document.getElementById('log-stream');
        container.innerHTML = '<div class="p-3"><i class="bi bi-activity me-2"></i>Stream iniciado... aguardando logs</div>';
        
        logStreamInterval = setInterval(() => {
            fetch('/api/admin/logs/stream')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.logs.length > 0) {
                        data.logs.forEach(log => {
                            addLogToStream(log);
                        });
                    }
                })
                .catch(error => console.error('Error in log stream:', error));
        }, 2000);
    }
    
    function stopLogStream() {
        if (logStreamInterval) {
            clearInterval(logStreamInterval);
            logStreamInterval = null;
        }
    }
    
    function addLogToStream(log) {
        const container = document.getElementById('log-stream');
        const timestamp = new Date(log.timestamp).toLocaleString();
        
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-timestamp">[${timestamp}]</span>
            <span class="log-level ${log.level}">${log.level.toUpperCase()}</span>
            <span class="log-source">[${log.type}]</span>
            <span class="log-message">${escapeHtml(log.message)}</span>
        `;
        
        container.appendChild(logEntry);
        container.scrollTop = container.scrollHeight;
        
        // Keep only last 100 entries
        while (container.children.length > 100) {
            container.removeChild(container.firstChild);
        }
    }
    
    function clearLogStream() {
        document.getElementById('log-stream').innerHTML = '<div class="p-3 text-muted">Stream limpo</div>';
    }
    
    function setupAutoRefresh() {
        autoRefreshInterval = setInterval(() => {
            if (document.getElementById('auto-refresh').checked) {
                refreshLogs();
            }
        }, 30000);
    }
    
    function cleanupOldLogs() {
        if (!confirm('Tem certeza que deseja remover logs antigos? Esta ação não pode ser desfeita.')) {
            return;
        }
        
        fetch('/api/admin/cleanup_logs', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${data.deleted_count} logs antigos foram removidos.`);
                    refreshLogs();
                } else {
                    alert('Erro: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error cleaning logs:', error);
                alert('Erro ao limpar logs');
            });
    }
    
    function exportLogs() {
        const params = new URLSearchParams(currentFilters);
        window.open(`/api/admin/logs/export?${params}`, '_blank');
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', function() {
        if (logStreamInterval) {
            clearInterval(logStreamInterval);
        }
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
        }
    });
</script>
{% endblock %}
